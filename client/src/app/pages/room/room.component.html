<div class="min-h-screen flex flex-col" [style.background]="'var(--body-bg)'">
  <!-- Header -->
  <app-room-header 
    [roomId]="room?.id || ''"
    [userName]="currentUser?.name || ''"
  ></app-room-header>

  <!-- Main Content -->
  <div *ngIf="room" class="flex-1 w-full mx-auto px-3 py-3">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 max-w-[2000px] mx-auto">
      <!-- Participant List (Left Sidebar) -->
      <div class="lg:col-span-2">
        <app-participant-list
          [participants]="room.participants"
          [currentUserId]="currentUserId"
        ></app-participant-list>
      </div>

      <!-- Voting Area (Main Content) -->
      <div class="lg:col-span-7 space-y-3">
        <!-- Task Description -->
        <div class="rounded-lg shadow-sm border p-3" [style.background-color]="'var(--card-bg)'" [style.border-color]="'var(--border)'">
          <label for="taskDescription" class="block text-xs font-medium mb-1" [style.color]="'var(--text-secondary)'">
            <i class="fas fa-pencil-alt" [style.color]="'var(--primary)'"></i> Task / Story Name (optional)
          </label>
          <input
            id="taskDescription"
            type="text"
            [(ngModel)]="taskDescription"
            (change)="onDescriptionChange()"
            [disabled]="room.votesRevealed"
            placeholder="Leave empty to auto-generate from timestamp..."
            class="w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-offset-1 outline-none transition-all disabled:cursor-not-allowed"
            [style.border-color]="'var(--border)'"
            [style.background-color]="room.votesRevealed ? 'var(--primary-light)' : 'var(--card-bg)'"
            [style.color]="'var(--text-primary)'"
          />
        </div>

        <!-- Voting Cards -->
        <div class="rounded-lg shadow-sm border p-3" [style.background-color]="'var(--card-bg)'" [style.border-color]="'var(--border)'">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-semibold" [style.color]="'var(--text-primary)'">
              <i class="fas" [style.color]="'var(--primary)'" [class.fa-check-circle]="room.votesRevealed" [class.fa-hand-pointer]="!room.votesRevealed"></i>
              {{ room.votesRevealed ? 'Voting Complete' : 'Select Your Estimate' }}
            </h3>
            <!-- Live Timer -->
            <div class="flex items-center space-x-2 px-3 py-1 rounded-lg border-2" [style.background-color]="'var(--primary-light)'" [style.border-color]="'var(--border)'">
              <i class="fas fa-stopwatch" [style.color]="'var(--primary)'"></i>
              <span class="font-mono font-bold text-lg" [style.color]="'var(--primary)'">{{ elapsedTime }}</span>
            </div>
          </div>
          
          <div class="flex flex-wrap gap-2 justify-center">
            <app-voting-card
              *ngFor="let value of votingValues; let i = index"
              [value]="value"
              [index]="i"
              [selected]="selectedVote === value"
              [disabled]="room.votesRevealed"
              (voteSelected)="onVoteSelected($event)"
            ></app-voting-card>
          </div>

          <div *ngIf="selectedVote && !room.votesRevealed" class="mt-3 text-center">
            <p class="text-xs" [style.color]="'var(--text-secondary)'">
              Your vote: <span class="font-bold text-lg" [style.color]="'var(--primary)'">{{ selectedVote }}</span>
            </p>
          </div>
        </div>

        <!-- Control Panel -->
        <app-control-panel
          [votesRevealed]="room.votesRevealed"
          [hasVotes]="hasVotes"
          (revealVotes)="onRevealVotes()"
          (clearVotes)="onClearVotes()"
          (leaveRoom)="onLeaveRoomClick()"
        ></app-control-panel>

        <!-- Results (Only shown when votes are revealed) -->
        <div *ngIf="room.votesRevealed">
          <app-results-display
            [participants]="room.participants"
          ></app-results-display>
        </div>
      </div>

      <!-- Voting History (Right Sidebar) -->
      <div class="lg:col-span-3">
        <app-voting-history
          [history]="room.votingHistory"
          [roomId]="room.id"
          (deleteHistory)="onDeleteHistory($event)"
        ></app-voting-history>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="!room" class="flex-1 flex items-center justify-center" [style.background]="'var(--body-bg)'">
    <div class="text-center">
      <div class="animate-spin rounded-full h-16 w-16 border-b-2 mx-auto mb-4" [style.border-color]="'var(--primary)'"></div>
      <p class="text-lg font-semibold" [style.color]="'var(--text-primary)'">Loading room...</p>
    </div>
  </div>

  <!-- Donation Modal -->
  <app-donation-modal
    *ngIf="showDonationModal"
    (close)="onCloseDonationModal()"
  ></app-donation-modal>

  <!-- Leave Confirmation Modal -->
  <app-confirm-modal
    *ngIf="showLeaveConfirm"
    title="Estimation Complete?"
    message="Are you finished with this estimation session? You can always rejoin with the room ID if needed!"
    confirmText="Yes, I'm Done"
    cancelText="Stay Longer"
    confirmButtonClass="primary"
    iconClass="fa-thumbs-up"
    [showDownload]="(room?.votingHistory?.length || 0) > 0"
    downloadText="Download Voting Results (JSON)"
    (confirm)="onConfirmLeave()"
    (cancel)="onCancelLeave()"
    (download)="onDownloadResults()"
  ></app-confirm-modal>
</div>
